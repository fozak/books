<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frappe Books Database Browser</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1, h2 {
      color: #333;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .error {
      color: #dc3545;
      background: #f8d7da;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      color: #155724;
      background: #d4edda;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .form-group {
      margin: 15px 0;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .loading {
      display: none;
      color: #007bff;
    }
  </style>
</head>
<body>
  <h1>üóÑÔ∏è Frappe Books Database Browser</h1>
  
  <div class="container">
    <h2>Server Status</h2>
    <button onclick="checkHealth()">Check Health</button>
    <div id="healthStatus"></div>
  </div>

  <div class="container">
    <h2>Database Tables</h2>
    <button onclick="loadTables()">Load Tables</button>
    <div id="tablesContainer"></div>
  </div>

  <div class="container">
    <h2>Table Data</h2>
    <div class="form-group">
      <label>Select Table:</label>
      <select id="tableSelect" onchange="loadTableData()">
        <option value="">-- Select a table --</option>
      </select>
    </div>
    <div class="form-group">
      <label>Limit:</label>
      <input type="number" id="limitInput" value="50" min="1" max="1000">
      <button onclick="loadTableData()">Load Data</button>
    </div>
    <div id="tableDataContainer"></div>
  </div>

  <div class="container">
    <h2>Search Records</h2>
    <div class="form-group">
      <label>Table:</label>
      <select id="searchTableSelect">
        <option value="">-- Select a table --</option>
      </select>
    </div>
    <div class="form-group">
      <label>Search Field:</label>
      <input type="text" id="searchField" value="name" placeholder="Field name to search in">
    </div>
    <div class="form-group">
      <label>Search Query:</label>
      <input type="text" id="searchQuery" placeholder="Enter search term">
      <button onclick="searchRecords()">Search</button>
    </div>
    <div id="searchResults"></div>
  </div>

  <div class="container">
    <h2>Custom SQL Query</h2>
    <div class="form-group">
      <label>SQL Query (SELECT only):</label>
      <textarea id="sqlQuery" rows="4" placeholder="SELECT * FROM tablename LIMIT 10"></textarea>
      <button onclick="executeQuery()">Execute Query</button>
    </div>
    <div id="queryResults"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001';

    // Simple API client
    class DatabaseClient {
      constructor(baseUrl) {
        this.baseUrl = baseUrl;
      }

      async request(endpoint, options = {}) {
        const url = `${this.baseUrl}${endpoint}`;
        const config = {
          headers: {
            'Content-Type': 'application/json',
          },
          ...options
        };

        try {
          const response = await fetch(url, config);
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.message || `HTTP ${response.status}`);
          }
          
          return data;
        } catch (error) {
          console.error('API Request failed:', error);
          throw error;
        }
      }

      async getHealth() {
        return this.request('/health');
      }

      async getTables() {
        return this.request('/api/tables');
      }

      async getTableSchema(tableName) {
        return this.request(`/api/schema/${tableName}`);
      }

      async getTableData(tableName, options = {}) {
        const params = new URLSearchParams();
        if (options.limit) params.append('limit', options.limit);
        if (options.offset) params.append('offset', options.offset);
        if (options.orderBy) params.append('orderBy', options.orderBy);
        if (options.order) params.append('order', options.order);
        
        const query = params.toString() ? `?${params.toString()}` : '';
        return this.request(`/api/data/${tableName}${query}`);
      }

      async searchRecords(tableName, field, query, limit = 50) {
        const params = new URLSearchParams({
          q: query,
          field: field,
          limit: limit
        });
        return this.request(`/api/search/${tableName}?${params.toString()}`);
      }

      async executeQuery(sql, params = []) {
        return this.request('/api/query', {
          method: 'POST',
          body: JSON.stringify({ sql, params })
        });
      }
    }

    const db = new DatabaseClient(API_BASE);

    // UI Functions
    function showError(containerId, message) {
      document.getElementById(containerId).innerHTML = 
        `<div class="error">‚ùå ${message}</div>`;
    }

    function showSuccess(containerId, message) {
      document.getElementById(containerId).innerHTML = 
        `<div class="success">‚úÖ ${message}</div>`;
    }

    function showLoading(containerId) {
      document.getElementById(containerId).innerHTML = 
        `<div class="loading">‚è≥ Loading...</div>`;
    }

    async function checkHealth() {
      const container = document.getElementById('healthStatus');
      showLoading('healthStatus');
      
      try {
        const health = await db.getHealth();
        container.innerHTML = `
          <div class="success">
            <h3>‚úÖ Server Healthy</h3>
            <pre>${JSON.stringify(health, null, 2)}</pre>
          </div>
        `;
      } catch (error) {
        showError('healthStatus', `Health check failed: ${error.message}`);
      }
    }

    async function loadTables() {
      const container = document.getElementById('tablesContainer');
      showLoading('tablesContainer');
      
      try {
        const response = await db.getTables();
        const tables = response.data;
        
        // Update table selects
        updateTableSelects(tables);
        
        container.innerHTML = `
          <div class="success">
            <h3>üìã Found ${tables.length} tables:</h3>
            <ul>
              ${tables.map(table => `<li>${table}</li>`).join('')}
            </ul>
          </div>
        `;
      } catch (error) {
        showError('tablesContainer', `Failed to load tables: ${error.message}`);
      }
    }

    function updateTableSelects(tables) {
      const selects = ['tableSelect', 'searchTableSelect'];
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Select a table --</option>';
        tables.forEach(table => {
          select.innerHTML += `<option value="${table}">${table}</option>`;
        });
      });
    }

    async function loadTableData() {
      const tableName = document.getElementById('tableSelect').value;
      const limit = document.getElementById('limitInput').value;
      const container = document.getElementById('tableDataContainer');
      
      if (!tableName) {
        showError('tableDataContainer', 'Please select a table');
        return;
      }
      
      showLoading('tableDataContainer');
      
      try {
        const response = await db.getTableData(tableName, { limit: parseInt(limit) });
        const { records, total } = response.data;
        
        if (records.length === 0) {
          container.innerHTML = '<div class="success">üì≠ No records found</div>';
          return;
        }
        
        // Create table
        const columns = Object.keys(records[0]);
        let tableHtml = `
          <div class="success">
            <h3>üìä ${tableName} (${records.length} of ${total} records)</h3>
            <table>
              <thead>
                <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
              </thead>
              <tbody>
        `;
        
        records.forEach(record => {
          tableHtml += '<tr>';
          columns.forEach(col => {
            const value = record[col];
            const displayValue = value === null ? '<em>null</em>' : 
                                 typeof value === 'object' ? JSON.stringify(value) : 
                                 String(value);
            tableHtml += `<td>${displayValue}</td>`;
          });
          tableHtml += '</tr>';
        });
        
        tableHtml += '</tbody></table></div>';
        container.innerHTML = tableHtml;
        
      } catch (error) {
        showError('tableDataContainer', `Failed to load data: ${error.message}`);
      }
    }

    async function searchRecords() {
      const tableName = document.getElementById('searchTableSelect').value;
      const field = document.getElementById('searchField').value;
      const query = document.getElementById('searchQuery').value;
      const container = document.getElementById('searchResults');
      
      if (!tableName || !field || !query) {
        showError('searchResults', 'Please fill in all search fields');
        return;
      }
      
      showLoading('searchResults');
      
      try {
        const response = await db.searchRecords(tableName, field, query);
        const { records, count } = response.data;
        
        if (count === 0) {
          container.innerHTML = '<div class="success">üì≠ No matching records found</div>';
          return;
        }
        
        // Create results table
        const columns = Object.keys(records[0]);
        let tableHtml = `
          <div class="success">
            <h3>üîç Search Results (${count} matches)</h3>
            <table>
              <thead>
                <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
              </thead>
              <tbody>
        `;
        
        records.forEach(record => {
          tableHtml += '<tr>';
          columns.forEach(col => {
            const value = record[col];
            const displayValue = value === null ? '<em>null</em>' : 
                                 typeof value === 'object' ? JSON.stringify(value) : 
                                 String(value);
            tableHtml += `<td>${displayValue}</td>`;
          });
          tableHtml += '</tr>';
        });
        
        tableHtml += '</tbody></table></div>';
        container.innerHTML = tableHtml;
        
      } catch (error) {
        showError('searchResults', `Search failed: ${error.message}`);
      }
    }

    async function executeQuery() {
      const sql = document.getElementById('sqlQuery').value.trim();
      const container = document.getElementById('queryResults');
      
      if (!sql) {
        showError('queryResults', 'Please enter a SQL query');
        return;
      }
      
      showLoading('queryResults');
      
      try {
        const response = await db.executeQuery(sql);
        const { results, count } = response.data;
        
        if (count === 0) {
          container.innerHTML = '<div class="success">üì≠ Query returned no results</div>';
          return;
        }
        
        // Create results table
        const columns = Object.keys(results[0]);
        let tableHtml = `
          <div class="success">
            <h3>‚ö° Query Results (${count} rows)</h3>
            <table>
              <thead>
                <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
              </thead>
              <tbody>
        `;
        
        results.forEach(record => {
          tableHtml += '<tr>';
          columns.forEach(col => {
            const value = record[col];
            const displayValue = value === null ? '<em>null</em>' : 
                                 typeof value === 'object' ? JSON.stringify(value) : 
                                 String(value);
            tableHtml += `<td>${displayValue}</td>`;
          });
          tableHtml += '</tr>';
        });
        
        tableHtml += '</tbody></table></div>';
        container.innerHTML = tableHtml;
        
      } catch (error) {
        showError('queryResults', `Query failed: ${error.message}`);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Frappe Books Database Browser loaded');
      console.log('API Base URL:', API_BASE);
    });
  </script>
</body>
</html>
